\chapter{Testovací API}
Další nedílnou součástí testovacího systému je framework pro zjednodušení psaní jednotlivých testů. Testovací API tvoří sada programů, kde každý z~nich vykonává specifický, a~v testování často opakující, úkon. Název každého programu se skládá s~předpony tl\_ a~názvu daného programu, který většinou vystihuje jeho účel. Hlavním cílem vytvoření testovacího API je zjednodušení psaní samotných testů, a~tím i převedení psaní testů z~programátorů k testerům.

V první fázi je k dispozici základní sada programů testovacího API, která je níže popsána. Dále bude podporováno dopisování vlastních programů testovacího API. Podporované programovací jazyky, pro psaní vlastních API programů, jsou jazyky C a~Bash. Pro jazyk C je možné využít knihovny pro komunikaci s~remote serverem a~komunikaci s~databází testovacího systému. Při psaní nových uživatelských programů testovacího API v~Bashi je možné využít pro komunikaci s~remote serverem program tl\_remote.

\section{Knihovna cspipe}
Knihovna libtl\_cspipe.so slouží ke komunikaci s~testovaným zařízení prostřednictvím remote serveru. Knihovna definuje názvy pojmenovaných rour, prostřednictvím kterých je komunikováno s~remote serverem, dále velikost příjímacího a~odesílacího bufferu a~výčet typů všech příkazů, které remote server podporuje. Pro výměnu dat přes roury slouží struktura message\_remote, která obsahuje process id dotazujícího programu, položku z~výčtu podporovaných příkazů a~buffer s~posílanými či přečtenými daty.

Knihovna obsahuje čtyři funkce pro komunikaci s~remote serverem. Inicializace spojení s~remote serverem je prováděna pomoví funkce client\_starting. Funkci se jako parametr předává process id běžícího programu a~při úspěšném připojení funkce vrací file deskriptor otevřeného spojení. Spojení je možné ukončit pomocí funkce client\_ending, které jsou předány parametry file deskriptor otevřeného spojení a~process id běžícího programu. Knihovna dále obsahuje funkce pro zápis do~otevřené serverové roury a~čtení z~klientské roury. Všechny tyto operace je možné provést funkcí pipe\_request, které se jako prametr předává typ žádosti, buffer s~obsahem předávané zprávy a~buffer pro naplnění přijaté zprávy. Tato funkce vrací -1 při neúspěchu při spojení s~remote serverem nebo testovaným zařízením a~jakékoliv kladné číslo při správné odezvě remote serveru.

\section{Knihovna database}
Knihovna database poskytuje funkce pro přístup a~manipulaci s~databází testovacího systému. Knihovna definuje přihlašovací údaje k samotné databázi a~strukturu jednotlivých tabulek. Knihovna také obsahuje funkce pro připojení k databází a~následně také odpojení od databáze. K dispozici je řada funkcí, pomocí kterých je možné získat jednotlivá data z~databáze. Data jsou z~databáze předávány jako dynamicky alokované vícerozměrné pole. Dále je možné využít funkce pro vkládání a~úpravu záznamů v~databázi. Databázové funkce primárně slouží k využití v~hlavním testovacím programu, ale i v~některých API programech najde tato knihovna využití.

\section{Knihovna utils}
Poslední vlastní používanou knihovnou je knihovna utils. Knihovna utlis obsahuje funkce pro změny v~systému. První funkce close\_all\_fds slouží k uzavření všech otevření souborových deskriptorů. Druhá a~zatím poslední funkce této knihovny zajišťuje rekurzivní mazání adresářů.

\section{Program checkproduct}
První program checkproduct slouží k získání názvu firmwaru patřícího do~daného výrobku. Syntaxe tohoto příkazu je \texttt{tl\_checkproduct <id>}. Jediným parametrem id zadáváme identifikační číslo zařízení. Program zjistí název firmwaru z~databáze pomocí databázového dotazu z~knihovny database.

\section{Program remote}
Základním programem pro komunikaci s~testovaným zařízením pomocí remote server je program remote. Syntaxe programu remote je \texttt{tl\_remote <id> <command>}. První parametr id určuje identifikační číslo zařízení, s~kterým chceme komunikovat. Druhým parametr command je samotný příkaz, jenž bude v~testovaném zařízení proveden. V~případě úspěšného navázání spojení s~testovaným zařízením vypíše program výstup provedeného příkazu na testovaném zařízením a~ukončí se s~identickým návratovým kódem. Jestliže se z~jakéhokoliv důvodu nepodařilo k testovanému zařízení připojit, tak je na chybový výstup vypsána příslušná hláška a~program se ukončí s~návratovým kódem 120. Program remote pro komunikaci s~remote serverem používá knihovnu cspipe.

\section{Program remotechange}
Pomocí programu remotechange je možné změnit parametry připojení a~přihlášení do~testovaného zařízení. Syntaxe programu je \texttt{tl\_remotechange [-p <port>] [-i <ip>] [-u <user>] [-s <pass>] [-t <protocol>] <id>}. Parametrem port je změněn TCP port na kterém se pokoušíme připojit. Parametr IP změní cílovou IP adresu připojení. Parametry user a~pass určují přihlašovací údaje, pomocí kterých se do~testovaného zařízení přihlašujeme. Parametr protocol určuje protokol připojení k testovanému zařízení, nyní jsou k dispozici protokoly telnet a~ssh. Posledním povinným parametrem id určíme zařízení, kterému chceme změnit parametry připojení. Program remotechange po~startu nejdříve odešle informace o změně parametrů připojení remote serveru, a~poté je odeslán remote serveru pokyn k restartu přípojení k testovanému zařízení.

\section{Program remoteinfo}
Program remoteinfo slouží k získání aktuálních informacích o parametrech připojení s~testovaným zařízením. Syntaxe programu je \texttt{tl\_remoteinfo [-p] or [-i] or [-u] or [-s] or [-t] <id>}. Program zpracuje pouze jeden zadaný přepínač, a~to ten poslední zadaný. Zadáním přepínače -p získáme port, pomocí kterého je testované zařízení připojeno. Při zadání přepínače -i program vrátí IP adresu zařízení, ke kterému je remote server připojen. Přepínače -u a~-s slouží ke zjištění uživatelského jména a~hesla, které byly použity k připojení do~testovaného zařízení. Při zadání posledního možného přepínače -t dostaneme zpět protokol pomocí, kterého jsme do~testovaného zařízení připojeni. Parametrem id zadáme identifikátor dotazovaného zařízení. Program pouze odešle žádost o informaci jednoho z~parametrů remote serveru a~vytiskne příchozí odpověď na standardní výstup.

\section{Program routerready}
Program routerready čeká na start testovaného zařízení, například po~rebootu zařízení. Syntaxe programu je \texttt{tl\_routerready [-t <timeout>]  <id>}. Prvním parametrem timeout lze zadat maximální čas čekání na start routeru, kdy defaultní čas je 120~s. Dále je potřeba zadat parametr id, což je identifikační číslo testovaného zařízení. V~první fázi čekání na naběhnutí zařízení je zkoušen ping na testované zařízení. Jestliže do~vypršení timeotu byla přijata odpověď, je pokračováno druhou fází testu. V~druhé fázi testu je zkoušeno připojení do~testovaného zařízení pomocí remote serveru. Jestliže do~vypršení timeoutu přijde od remote serveru validní odpověď, je vypsán celkový čas čekání na start routeru a~program ukončen. V~případě vypršení timeoutu v~jakékoliv fázi je vypsána chybová hláška a~program je ukončen s~návratovým kódem 2.

\section{Program status}
Programem status je možné z~testovaného zařízení vyčíst status zařízení, či přímo pouze hodnotu položky statusu zařízení. Syntaxe tohoto programu je \texttt{tl\_status <id> <category> [<subcategory>]}. Prvním parametrem id je zadáno identifikační čislo zařízení, ze kterého má být status vyčten. Druhým parametrem category určíme požadovanou kategorii statusu, například lan pro informace o síťovém rozhraní. Poslední volitelnou položkou subcategory určíme jakou položku v~dané kategorii má program vytisknout. U již zmíněné kategorie lan si můžeme nechat vrátit například položku MAC Address.

\section{Program updateconf}
Pro nahrání nové konfigurace do~testovaného zařízení slouží program updateconf. Syntaxe programu je \texttt{tl\_updateconf -f <config> -t <function> [-d <confdir>] <id>}. Prvním parametrem config je určen název konfigurace, jenž má být do~routeru nahrávána. Parametr function určuje testovanou funkci nahrávané konfigurace. Třetím volitelným parametrem confdir je možné změnit adresář s~nahrávanými konfiguracemi. Výchozí adresář je /var/testlab/conf. Poslední parametr id určuje router, do~kterého má být nová konfigurace nahrána. V~první fázi jsou z~remote serveru příslušného zařízení zjištěny přístupové a~přihlašovací údaje k testovanému zařízení. Dále je pomocí programu curl nahrána nová konfigurace do~testovaného zařízení. V~případě jakékoliv chyby je aplikace ukončena se stejným návratovým kódem jakým byl ukončen program curl.

\section{Program updatefw}
Nahrávání nového firmwaru do~testovaného zařízení je prováděno pomocí programu updatefw. Syntaxe programu updatefw je \texttt{tl\_updatefw -r <release> -f <firmware> [-d <fwdir>] <id>}. Prvním parametrem release určíme z~jakého přeloženého releasu má být firmware vybrán. Parametr firmware určuje název nahrávaného firmwaru. Třetí volitelný parametr fwdir umožňuje změnit adresář, odkud jsou firmwary vybírány. Defaultní adresář je /var/testlab/firmware. Posledním parametrem id určíme do~jakého testovaného zařízení má být nový firmware nahrán. Při nahrávání nového firmwaru jsou nejdříve z~remote server příslušného zařízení zjištěny přístupové a~přihlašovací údaje testovaného zařízení. Dále pomocí programu curl je nahrán do~zařízení nový firmware, po~nahrání nového firmwaru do~zařízení se zařízení začne automaticky aktualizovat. Program updatefw je ukončen se stejným návratovým kódem jako program nahrávající nový firmware curl.

\section{Program slog}
Programem slog je možné vyčíst a~filtrovat systémový log testovaného zařízení. Syntaxe programu je následující \texttt{tl\_slog [-n <lines>] [-p <program>] <id>}. Prvním volitelný parametrem upravujeme počet vypisovaných řádků systémového logu. Defaultně je vypisováno sto řádků logu. Druhým také volitelný parametrem je možné filtrovat vypisované řádky logu, například podle spuštěného programu. Posledním parametrem id je určeno, z~jakého testovaného zařízení je systémový log vyčítán. Program po~spuštění provádí pouze vyčítání systémového logu prostřednictvím remote serveru z~testovaného zařízení a~případně systémový log dále filtruje dle zadaného parametru.

\section{Program rlog}
Programem rlog je možné vyčítat a~filtrovat reboot log testovaného zařízení. Reboot log obsahuje důvody, kvůli jakým bylo testované zařízení v~minulosti restartováno. Syntaxe programu rlog je \texttt{tl\_rlog [-p <program>] <id>}. Pomocí prvního parametru program je možné filtrovat vypisované řádky reboot logu. Druhý parametr id určuje testované zařízení, ze kterého je reboot log vyčítán. Program rlog po~spuštění pomocí remote server pouze vyčte z~testovaného zařízení reboot log a~případně filtruje řádky podle zadaného parametru.

\section{Program klog}
Posledním ze sady programů určených pro vyčítání logů z~testovaných zařízeních je je program klog. Programem klog je vyčítán kernel log testovaného zařízení. Syntaxe tohoto programu je \texttt{tl\_klog [-p <program>] <id>}. Prvním volitelným parametrem lze nastavit filtrování vypisovaných řádků kernel logu. Parametr id určuje testované zařízení, ze~kterého bude kernel log vyčítán. Program klog po~spuštění pomocí remote server přes príkaz dmesg vyčte z~testovaného zařízení kernel log a~dále ho případně filtruje podle zadaného parametru, či přímo tiskne na standardní výstup.

\section{Program changeparam}
Program changeparam slouží k provedení změny jednotlivých položek konfigurace testovaného zařízení. Změna se projeví ihned po~provedení příkazu a~není nutné žádné nahrávání konfigurace do~zařízení. Syntaxe programu remotechange je \texttt{tl\_changeparam -f <function> -p <param> [-r <profile>] <id> <value>}. Prvním parametrem function je určena funkce, u které se parametr mění, například ppp u mobilního spojení. Druhým parametrem param je určen měněný parametr. U funkce ppp můžeme změnit například parametr apn. Volitelným parametrem profile je možné určit jiný profil konfigurace, kde bude parametr měněn. Dalším parametrem id zvolíme testované zařízení, kterému má být určený parametr změněn. Poslední parametr value udává novou hodnotu měněného parametru. Program changeparam po~kontrole všech parametrů převádí názvy těchto parametrů na velká a~malá písmena dle potřeby testovaných zařízení. Dále je sestaven příkaz pro změnu parametru v~testovaném zařízení pomocí programu sed a~následně je pomocí remote server odeslán do~testovaného zařízení.

\section{Program mobileready}
Program mobilready slouží k čekání na navázání mobilního spojení testovaného zařízení. Syntaxe programu je \texttt{tl\_mobileready [-t <timeout>] <id>}. Prvním volitelným parametrem timeout je možné změnit maximální čas čekání na připojení zařízení do~mobilní sítě. Defaultní čas čekání je 120~s. Druhým parametrem id je určeno testované zařízení. Program provádí kontrolu čekání na mobilní spojení kontrolou přiřazením IP adresy mobilnímu rozhraní. Kontrola IP adresy je prováděno každou sekundu až do~vypršení timeoutu nebo do~úspěšného navázaní spojení.
\endinput
